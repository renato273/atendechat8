flowchart LR
    A["ðŸ“¨ Mensaje recibido"] --> B["ðŸ”” Evento: messages.upsert"]
    B --> C["âœ… verifyContact"]
    C --> D["ðŸ‘¤ Contacto creado/actualizado"]
    D --> E["ðŸŽ« Ticket creado/encontrado"]
    E --> F["âœ… Mensaje guardado"]
    
    F --> G["âœ… Socket.IO Events"]
    G --> H["ðŸ”” company-{id}-contact"]
    G --> I["ðŸ”” company-{id}-ticket"]
    G --> J["ðŸ”” company-{id}-appMessage"]
    
    H --> K["ðŸ“± Frontend: Contactos"]
    I --> L["ðŸ“± Frontend: Tickets"]
    J --> M["âœ… Frontend: Mensajes"]
    
    K --> N["ðŸ‘ï¸ UI actualizada"]
    L --> N
    M --> N
    
    N --> O["ðŸ”” Notificaciones para agentes"]
    
    style A fill:#e1f5fe
    style G fill:#fff3e0
    style N fill:#c8e6c9
    style O fill:#e8f5e8
