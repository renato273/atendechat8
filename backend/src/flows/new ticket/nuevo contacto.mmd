flowchart TD
    A[ï¿½ï¿½ Cliente envÃ­a mensaje] --> B[ðŸ“² WhatsApp recibe]
    B --> C[ðŸ”„ Sistema detecta mensaje]
    
    C --> D{Â¿Contacto existe?}
    D -->|NO| E[ðŸ†• Nuevo contacto detectado]
    D -->|SÃ| F[ï¿½ï¿½ Contacto existente]
    
    E --> G[ðŸ” Obtener foto de perfil]
    G --> H[ï¿½ï¿½ GetProfilePicUrl]
    H --> I{Â¿Foto disponible?}
    I -->|SÃ| J[ðŸ’¾ Guardar URL de foto]
    I -->|NO| K[ðŸ–¼ï¸ Usar imagen por defecto]
    
    J --> L[ðŸ“ Crear contacto en BD]
    K --> L
    
    L --> M[ðŸ‘¤ CreateOrUpdateContactService]
    M --> N[ï¿½ï¿½ Contacto creado en BD]
    
    F --> O[ðŸ“‹ Buscar contacto existente]
    O --> P[ðŸ”„ Actualizar datos si es necesario]
    
    N --> Q[ðŸŽ« Crear/Encontrar Ticket]
    P --> Q
    
    Q --> R{Â¿Ticket existe?}
    R -->|NO| S[ï¿½ï¿½ Crear nuevo ticket]
    R -->|SÃ| T[ï¿½ï¿½ Ticket existente]
    
    S --> U[ðŸ“ Nuevo ticket: status = pending]
    T --> V[ðŸ”„ Verificar estado del ticket]
    
    U --> W[ðŸ“‹ Ticket creado en BD]
    V --> X{Â¿Status = closed?}
    
    W --> Y[ðŸ”” Emitir evento: ticket creado]
    X -->|SÃ| Z[ðŸ”„ Reabrir ticket]
    X -->|NO| AA[ðŸ“‹ Mantener estado actual]
    
    Z --> BB[ï¿½ï¿½ Status = pending]
    BB --> CC[ðŸ§¹ Limpiar queueId y userId]
    
    Y --> DD[ðŸ“¨ Crear mensaje en BD]
    CC --> DD
    
    DD --> EE[ðŸ’¾ Mensaje guardado en BD]
    EE --> FF[ðŸ”” Emitir evento: mensaje creado]
    
    FF --> GG[ï¿½ï¿½ Frontend se actualiza]
    GG --> HH[ï¿½ï¿½ï¸ Ticket aparece en lista]
    HH --> II[ðŸ”” NotificaciÃ³n para agentes]
    
    style A fill:#e1f5fe
    style E fill:#fff3e0
    style S fill:#fff3e0
    style U fill:#fff3e0
    style Y fill:#c8e6c9
    style FF fill:#c8e6c9
    style GG fill:#e8f5e8